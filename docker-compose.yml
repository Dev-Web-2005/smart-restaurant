version: '3.8'

services:
  # ==================== DATABASES ====================
  
  # PostgreSQL for Identity Service
  postgres-identity:
    image: postgres:15-alpine
    container_name: postgres-identity
    environment:
      POSTGRES_DB: identity_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
    volumes:
      - postgres-identity-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - smart-restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for Profile Service
  postgres-profile:
    image: postgres:15-alpine
    container_name: postgres-profile
    environment:
      POSTGRES_DB: profile_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
    volumes:
      - postgres-profile-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    networks:
      - smart-restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for Product Service
  postgres-product:
    image: postgres:15-alpine
    container_name: postgres-product
    environment:
      POSTGRES_DB: product_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
    volumes:
      - postgres-product-data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    networks:
      - smart-restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for Table Service
  postgres-table:
    image: postgres:15-alpine
    container_name: postgres-table
    environment:
      POSTGRES_DB: table_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
    volumes:
      - postgres-table-data:/var/lib/postgresql/data
    ports:
      - "5435:5432"
    networks:
      - smart-restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for Order Service
  postgres-order:
    image: postgres:15-alpine
    container_name: postgres-order
    environment:
      POSTGRES_DB: order_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
    volumes:
      - postgres-order-data:/var/lib/postgresql/data
    ports:
      - "5436:5432"
    networks:
      - smart-restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for caching and sessions
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - smart-restaurant-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================== BACKEND SERVICES ====================

  # Identity Service
  identity-service:
    build:
      context: ./src/backend/identity
      dockerfile: Dockerfile
    container_name: identity-service
    environment:
      NODE_ENV: production
      PORT: 3001
      DATABASE_HOST: postgres-identity
      DATABASE_PORT: 5432
      DATABASE_NAME: identity_db
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres123
      JWT_SECRET: your-secret-key-change-in-production
      JWT_EXPIRES_IN: 7d
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "3001:3001"
    depends_on:
      postgres-identity:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - smart-restaurant-network
    restart: unless-stopped

  # Profile Service
  profile-service:
    build:
      context: ./src/backend/profile
      dockerfile: Dockerfile
    container_name: profile-service
    environment:
      NODE_ENV: production
      PORT: 3002
      DATABASE_HOST: postgres-profile
      DATABASE_PORT: 5432
      DATABASE_NAME: profile_db
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres123
      IDENTITY_SERVICE_URL: http://identity-service:3001
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "3002:3002"
    depends_on:
      postgres-profile:
        condition: service_healthy
      identity-service:
        condition: service_started
      redis:
        condition: service_healthy
    networks:
      - smart-restaurant-network
    restart: unless-stopped

  # Product Service
  product-service:
    build:
      context: ./src/backend/product
      dockerfile: Dockerfile
    container_name: product-service
    environment:
      NODE_ENV: production
      PORT: 3003
      DATABASE_HOST: postgres-product
      DATABASE_PORT: 5432
      DATABASE_NAME: product_db
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres123
      IDENTITY_SERVICE_URL: http://identity-service:3001
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "3003:3003"
    depends_on:
      postgres-product:
        condition: service_healthy
      identity-service:
        condition: service_started
      redis:
        condition: service_healthy
    networks:
      - smart-restaurant-network
    restart: unless-stopped

  # Table Service
  table-service:
    build:
      context: ./src/backend/table
      dockerfile: Dockerfile
    container_name: table-service
    environment:
      NODE_ENV: production
      PORT: 3004
      DATABASE_HOST: postgres-table
      DATABASE_PORT: 5432
      DATABASE_NAME: table_db
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres123
      IDENTITY_SERVICE_URL: http://identity-service:3001
      QR_SECRET: your-qr-secret-change-in-production
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "3004:3004"
    depends_on:
      postgres-table:
        condition: service_healthy
      identity-service:
        condition: service_started
      redis:
        condition: service_healthy
    networks:
      - smart-restaurant-network
    restart: unless-stopped

  # Order Service
  order-service:
    build:
      context: ./src/backend/order
      dockerfile: Dockerfile
    container_name: order-service
    environment:
      NODE_ENV: production
      PORT: 3005
      DATABASE_HOST: postgres-order
      DATABASE_PORT: 5432
      DATABASE_NAME: order_db
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres123
      IDENTITY_SERVICE_URL: http://identity-service:3001
      PRODUCT_SERVICE_URL: http://product-service:3003
      TABLE_SERVICE_URL: http://table-service:3004
      NOTIFICATION_SERVICE_URL: http://notification-service:3007
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "3005:3005"
    depends_on:
      postgres-order:
        condition: service_healthy
      identity-service:
        condition: service_started
      product-service:
        condition: service_started
      table-service:
        condition: service_started
      redis:
        condition: service_healthy
    networks:
      - smart-restaurant-network
    restart: unless-stopped

  # Notification Service
  notification-service:
    build:
      context: ./src/backend/notification
      dockerfile: Dockerfile
    container_name: notification-service
    environment:
      NODE_ENV: production
      PORT: 3007
      IDENTITY_SERVICE_URL: http://identity-service:3001
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # Email configuration (optional)
      SMTP_HOST: smtp.gmail.com
      SMTP_PORT: 587
      SMTP_USER: your-email@gmail.com
      SMTP_PASSWORD: your-password
    ports:
      - "3007:3007"
    depends_on:
      identity-service:
        condition: service_started
      redis:
        condition: service_healthy
    networks:
      - smart-restaurant-network
    restart: unless-stopped

  # Kitchen Service
  kitchen-service:
    build:
      context: ./src/backend/kitchen
      dockerfile: Dockerfile
    container_name: kitchen-service
    environment:
      NODE_ENV: production
      PORT: 3008
      IDENTITY_SERVICE_URL: http://identity-service:3001
      ORDER_SERVICE_URL: http://order-service:3005
      NOTIFICATION_SERVICE_URL: http://notification-service:3007
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "3008:3008"
    depends_on:
      identity-service:
        condition: service_started
      order-service:
        condition: service_started
      notification-service:
        condition: service_started
      redis:
        condition: service_healthy
    networks:
      - smart-restaurant-network
    restart: unless-stopped

  # Waiter Service
  waiter-service:
    build:
      context: ./src/backend/waiter
      dockerfile: Dockerfile
    container_name: waiter-service
    environment:
      NODE_ENV: production
      PORT: 3009
      IDENTITY_SERVICE_URL: http://identity-service:3001
      ORDER_SERVICE_URL: http://order-service:3005
      TABLE_SERVICE_URL: http://table-service:3004
      NOTIFICATION_SERVICE_URL: http://notification-service:3007
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "3009:3009"
    depends_on:
      identity-service:
        condition: service_started
      order-service:
        condition: service_started
      table-service:
        condition: service_started
      notification-service:
        condition: service_started
      redis:
        condition: service_healthy
    networks:
      - smart-restaurant-network
    restart: unless-stopped

  # API Gateway
  api-gateway:
    build:
      context: ./src/backend/api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    environment:
      NODE_ENV: production
      PORT: 8888
      IDENTITY_SERVICE_URL: http://identity-service:3001
      PROFILE_SERVICE_URL: http://profile-service:3002
      PRODUCT_SERVICE_URL: http://product-service:3003
      TABLE_SERVICE_URL: http://table-service:3004
      ORDER_SERVICE_URL: http://order-service:3005
      NOTIFICATION_SERVICE_URL: http://notification-service:3007
      KITCHEN_SERVICE_URL: http://kitchen-service:3008
      WAITER_SERVICE_URL: http://waiter-service:3009
      JWT_SECRET: your-secret-key-change-in-production
      REDIS_HOST: redis
      REDIS_PORT: 6379
      CORS_ORIGIN: http://localhost:3000
    ports:
      - "8888:8888"
    depends_on:
      - identity-service
      - profile-service
      - product-service
      - table-service
      - order-service
      - notification-service
      - kitchen-service
      - waiter-service
      - redis
    networks:
      - smart-restaurant-network
    restart: unless-stopped

  # ==================== FRONTEND ====================

  # Frontend (React + Vite)
  frontend:
    build:
      context: ./src/frontend
      dockerfile: Dockerfile
    container_name: frontend
    environment:
      VITE_API_URL: http://localhost:8888/api
      VITE_WS_URL: ws://localhost:8888/ws
    ports:
      - "3000:80"
    depends_on:
      - api-gateway
    networks:
      - smart-restaurant-network
    restart: unless-stopped

# ==================== NETWORKS ====================
networks:
  smart-restaurant-network:
    driver: bridge
    name: smart-restaurant-network

# ==================== VOLUMES ====================
volumes:
  postgres-identity-data:
    name: postgres-identity-data
  postgres-profile-data:
    name: postgres-profile-data
  postgres-product-data:
    name: postgres-product-data
  postgres-table-data:
    name: postgres-table-data
  postgres-order-data:
    name: postgres-order-data
  redis-data:
    name: redis-data
