name: "deploy-backend"

on:
  push:
    branches: ["master", "release", "develop"]
    tags:
      - "v*"
    paths:
      - "src/backend/**"
      - ".github/workflows/backend.yaml"
      - "package*.json"
  pull_request:
    branches: ["master", "release", "develop"]
    paths:
      - "src/backend/**"
      - ".github/workflows/backend.yaml"
      - "package*.json"

  workflow_dispatch:

env: # Global environment variables shared across services
  HOST_DB: ${{ secrets.HOST_DB }}
  PORT_DB: ${{ secrets.PORT_DB }}
  USERNAME_DB: ${{ secrets.USERNAME_DB }}
  PASSWORD_DB: ${{ secrets.PASSWORD_DB }}
  DATABASE_DB: ${{ secrets.DATABASE_DB }}

  X_API_KEY: ${{ secrets.X_API_KEY }}

  IDENTITY_API_KEY: ${{ secrets.IDENTITY_API_KEY }}
  PROFILE_API_KEY: ${{ secrets.PROFILE_API_KEY }}
  PRODUCT_API_KEY: ${{ secrets.PRODUCT_API_KEY }}
  TABLE_API_KEY: ${{ secrets.TABLE_API_KEY }}
  KITCHEN_API_KEY: ${{ secrets.KITCHEN_API_KEY }}
  NOTIFICATION_API_KEY: ${{ secrets.NOTIFICATION_API_KEY }}

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      rabbitmq:
        image: rabbitmq:3-management
        ports:
          - 5672:5672
          - 15672:15672
        env:
          RABBITMQ_DEFAULT_USER: supper
          RABBITMQ_DEFAULT_PASS: supper
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 25

      - run: mkdir result

      - name: Shared services
        run: |
          cd src/backend/shared
          npm ci
          npm run build
          rm -rf test
          mkdir -p ../../../result/shared
          cp -r . ../../../result/shared/

      - name: Api gateway services
        env: # Api gateway environment variables
          PORT: 8888
          MOD: production
          IDENTITY_SERVICE_URL: ${{ vars.IDENTITY_SERVICE_URL }}
          HOST_IDENTITY_SERVICE: ${{ vars.HOST_IDENTITY_SERVICE }}
          PORT_IDENTITY_SERVICE: ${{ vars.PORT_IDENTITY_SERVICE }}

          PROFILE_SERVICE_URL: ${{ vars.PROFILE_SERVICE_URL }}
          HOST_PROFILE_SERVICE: ${{ vars.HOST_PROFILE_SERVICE }}
          PORT_PROFILE_SERVICE: ${{ vars.PORT_PROFILE_SERVICE }}

          PRODUCT_SERVICE_URL: ${{ vars.PRODUCT_SERVICE_URL }}
          HOST_PRODUCT_SERVICE: ${{ vars.HOST_PRODUCT_SERVICE }}
          PORT_PRODUCT_SERVICE: ${{ vars.PORT_PRODUCT_SERVICE }}

          TABLE_SERVICE_URL: ${{ vars.TABLE_SERVICE_URL }}
          HOST_TABLE_SERVICE: ${{ vars.HOST_TABLE_SERVICE }}
          PORT_TABLE_SERVICE: ${{ vars.PORT_TABLE_SERVICE }}

          REFRESH_TOKEN_EXPIRES_IN: ${{ vars.REFRESH_TOKEN_EXPIRES_IN }}

          FRONTEND_URL: ${{ vars.FRONTEND_URL }}
          COOKIE_DOMAIN: ${{ vars.COOKIE_DOMAIN }}
        run: |
          cd src/backend/api-gateway
          npm ci
          npm run build
          rm -rf src test
          mkdir -p ../../../result/api-gateway
          cp -r . ../../../result/api-gateway/

      - name: Identity services
        env: # Identity service environment variables
          PORT: 8080
          HOST_PROFILE_SERVICE: ${{ vars.HOST_PROFILE_SERVICE }}
          PORT_PROFILE_SERVICE: ${{ vars.PORT_PROFILE_SERVICE }}
          ACCESS_TOKEN_EXPIRY: 5m
          PROFILE_API_KEY: ${{ secrets.PROFILE_API_KEY }}
          REFRESH_TOKEN_EXPIRY: 7d
          JWT_SECRET_KEY_ACCESS: ${{ secrets.JWT_SECRET_KEY_ACCESS }}
          JWT_SECRET_KEY_REFRESH: ${{ secrets.JWT_SECRET_KEY_REFRESH }}
          CONNECTION_AMQP: amqp://supper:supper@localhost:5672

        run: |
          cd src/backend/identity
          npm ci
          npm run build
          rm -rf src test
          mkdir -p ../../../result/identity
          cp -r . ../../../result/identity/

      - name: Product services
        env:
          PORT: 8082

        run: |
          cd src/backend/product
          npm ci
          npm run build
          rm -rf src test
          mkdir -p ../../../result/product
          cp -r . ../../../result/product/

      - name: Profile services
        env:
          PORT: 8081

        run: |
          cd src/backend/profile
          npm ci
          npm run build
          rm -rf src test
          mkdir -p ../../../result/profile
          cp -r . ../../../result/profile/

      - name: Table services
        env:
          PORT: 8083
          QR_SECRET_KEY: ${{ secrets.QR_SECRET_KEY }}
          QR_BASE_URL: ${{ vars.QR_BASE_URL }}

        run: |
          cd src/backend/table
          npm ci
          npm run build
          rm -rf src test
          mkdir -p ../../../result/table
          cp -r . ../../../result/table/

      - name: Kitchen services
        env:
          PORT: 8086
          CONNECTION_AMQP: amqp://supper:supper@localhost:5672

        run: |
          cd src/backend/kitchen
          npm ci
          npm run build
          rm -rf src test
          mkdir -p ../../../result/kitchen
          cp -r . ../../../result/kitchen/

      - name: Notification services
        env:
          PORT: 8085
          CONNECTION_AMQP: amqp://supper:supper@localhost:5672

        run: |
          cd src/backend/notification
          npm ci
          npm run build
          rm -rf src test
          mkdir -p ../../../result/notification
          cp -r . ../../../result/notification/

      - uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: result

  deploy:
    needs: test
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: folder-contain-backend/result

      - name: Copy backend folder to server
        uses: appleboy/scp-action@v0.1.6
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "folder-contain-backend/result/*"
          target: "/home/${{ secrets.VPS_USER }}/projects/"
          strip_components: 1

      - name: Connect to server and restart backend service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          key: ${{ secrets.VPS_KEY }}
          port: ${{ secrets.VPS_PORT }}
          username: ${{ secrets.VPS_USER }}
          script: |

            # Backup 
            cp -r /home/${{ secrets.VPS_USER }}/projects/result/* /home/${{ secrets.VPS_USER }}/projects/backup/container
            cd /home/${{ secrets.VPS_USER }}/projects/backup
            TIMESTAMP=$(date +"%Y%m%d%H%M%S")
            zip -r backend_$TIMESTAMP.zip container/
            sudo rm -rf container/*
            echo "✓ Backup completed"

            # Stop all services
            cd /home/${{ secrets.VPS_USER }}/projects/result
            pm2 delete all || true

            # Setup api-gateway
            cd api-gateway
            cat > .env << 'EOF'
            PORT=8888
            MOD=production
            HOST_DB=${{ secrets.HOST_DB }}
            PORT_DB=${{ secrets.PORT_DB }}
            USERNAME_DB=${{ secrets.USERNAME_DB }}
            PASSWORD_DB=${{ secrets.PASSWORD_DB }}
            DATABASE_DB=${{ secrets.DATABASE_DB }}
            X_API_KEY=${{ secrets.X_API_KEY }}
            IDENTITY_API_KEY=${{ secrets.IDENTITY_API_KEY }}
            PROFILE_API_KEY=${{ secrets.PROFILE_API_KEY }}
            PRODUCT_API_KEY=${{ secrets.PRODUCT_API_KEY }}
            TABLE_API_KEY=${{ secrets.TABLE_API_KEY }}
            IDENTITY_SERVICE_URL=${{ vars.IDENTITY_SERVICE_URL }}
            HOST_IDENTITY_SERVICE=${{ vars.HOST_IDENTITY_SERVICE }}
            PORT_IDENTITY_SERVICE=${{ vars.PORT_IDENTITY_SERVICE }}
            PROFILE_SERVICE_URL=${{ vars.PROFILE_SERVICE_URL }}
            HOST_PROFILE_SERVICE=${{ vars.HOST_PROFILE_SERVICE }}
            PORT_PROFILE_SERVICE=${{ vars.PORT_PROFILE_SERVICE }}
            PRODUCT_SERVICE_URL=${{ vars.PRODUCT_SERVICE_URL }}
            HOST_PRODUCT_SERVICE=${{ vars.HOST_PRODUCT_SERVICE }}
            PORT_PRODUCT_SERVICE=${{ vars.PORT_PRODUCT_SERVICE }}
            TABLE_SERVICE_URL=${{ vars.TABLE_SERVICE_URL }}
            HOST_TABLE_SERVICE=${{ vars.HOST_TABLE_SERVICE }}
            PORT_TABLE_SERVICE=${{ vars.PORT_TABLE_SERVICE }}
            HOST_NOTIFICATION_SERVICE=${{ vars.HOST_NOTIFICATION_SERVICE }}
            PORT_NOTIFICATION_SERVICE=${{ vars.PORT_NOTIFICATION_SERVICE }}
            NOTIFICATION_API_KEY=${{ secrets.NOTIFICATION_API_KEY }}
            REFRESH_TOKEN_EXPIRES_IN=${{ secrets.REFRESH_TOKEN_EXPIRES_IN }}
            FRONTEND_URL=${{ vars.FRONTEND_URL }}
            COOKIE_DOMAIN=${{ vars.COOKIE_DOMAIN }}
            EOF
            echo "✓ Api-gateway .env created"
            cat .env
            pm2 start dist/api-gateway/src/main.js --name api-gateway
            cd ..

            # Setup identity
            cd identity
            cat > .env << 'EOF'
            PORT=8080
            HOST_DB=${{ secrets.HOST_DB }}
            PORT_DB=${{ secrets.PORT_DB }}
            USERNAME_DB=${{ secrets.USERNAME_DB }}
            PASSWORD_DB=${{ secrets.PASSWORD_DB }}
            DATABASE_DB=${{ secrets.DATABASE_DB }}
            X_API_KEY=${{ secrets.X_API_KEY }}
            IDENTITY_API_KEY=${{ secrets.IDENTITY_API_KEY }}
            HOST_PROFILE_SERVICE=${{ vars.HOST_PROFILE_SERVICE }}
            PORT_PROFILE_SERVICE=${{ vars.PORT_PROFILE_SERVICE }}
            ACCESS_TOKEN_EXPIRY=5m
            REFRESH_TOKEN_EXPIRY=7d
            PROFILE_API_KEY=${{ secrets.PROFILE_API_KEY }}
            JWT_SECRET_KEY_ACCESS=${{ secrets.JWT_SECRET_KEY_ACCESS }}
            JWT_SECRET_KEY_REFRESH=${{ secrets.JWT_SECRET_KEY_REFRESH }}
            JWT_SECRET_KEY_RESET_PASSWORD=${{ secrets.JWT_SECRET_KEY_RESET_PASSWORD }}
            FRONTEND_URL=${{ vars.FRONTEND_URL }}
            CONNECTION_AMQP=${{ secrets.CONNECTION_AMQP }}
            NOTIFICATION_API_KEY=${{ secrets.NOTIFICATION_API_KEY }}
            EOF
            echo "✓ Identity .env created"
            cat .env
            pm2 start dist/identity/src/main.js --name identity
            cd ..

            # Setup product
            cd product
            cat > .env << 'EOF'
            PORT=8082
            HOST_DB=${{ secrets.HOST_DB }}
            PORT_DB=${{ secrets.PORT_DB }}
            USERNAME_DB=${{ secrets.USERNAME_DB }}
            PASSWORD_DB=${{ secrets.PASSWORD_DB }}
            DATABASE_DB=${{ secrets.DATABASE_DB }}
            X_API_KEY=${{ secrets.X_API_KEY }}
            PRODUCT_API_KEY=${{ secrets.PRODUCT_API_KEY }}
            EOF
            echo "✓ Product .env created"
            cat .env
            pm2 start dist/product/src/main.js --name product
            cd ..

            # Setup profile
            cd profile
            cat > .env << 'EOF'
            PORT=8081
            HOST_DB=${{ secrets.HOST_DB }}
            PORT_DB=${{ secrets.PORT_DB }}
            USERNAME_DB=${{ secrets.USERNAME_DB }}
            PASSWORD_DB=${{ secrets.PASSWORD_DB }}
            DATABASE_DB=${{ secrets.DATABASE_DB }}
            X_API_KEY=${{ secrets.X_API_KEY }}
            PROFILE_API_KEY=${{ secrets.PROFILE_API_KEY }}
            EOF
            echo "✓ Profile .env created"
            cat .env
            pm2 start dist/profile/src/main.js --name profile
            cd ..

            # Setup table
            cd table
            cat > .env << 'EOF'
            PORT=8083
            HOST_DB=${{ secrets.HOST_DB }}
            PORT_DB=${{ secrets.PORT_DB }}
            USERNAME_DB=${{ secrets.USERNAME_DB }}
            PASSWORD_DB=${{ secrets.PASSWORD_DB }}
            DATABASE_DB=${{ secrets.DATABASE_DB }}
            X_API_KEY=${{ secrets.X_API_KEY }}
            TABLE_API_KEY=${{ secrets.TABLE_API_KEY }}
            QR_SECRET_KEY=${{ secrets.QR_SECRET_KEY }}
            QR_BASE_URL=${{ vars.QR_BASE_URL }}
            EOF
            echo "✓ Table .env created"
            cat .env
            pm2 start dist/table/src/main.js --name table
            cd ..

            # Setup kitchen
            cd kitchen
            cat > .env << 'EOF'
            PORT=8086
            HOST_DB=${{ secrets.HOST_DB }}
            PORT_DB=${{ secrets.PORT_DB }}
            USERNAME_DB=${{ secrets.USERNAME_DB }}
            PASSWORD_DB=${{ secrets.PASSWORD_DB }}
            DATABASE_DB=${{ secrets.DATABASE_DB }}
            X_API_KEY=${{ secrets.X_API_KEY }}
            KITCHEN_API_KEY=${{ secrets.KITCHEN_API_KEY }}
            CONNECTION_AMQP=${{ secrets.CONNECTION_AMQP }}
            LIMIT_REQUEUE=10
            EOF
            echo "✓ Kitchen .env created"
            cat .env
            pm2 start dist/kitchen/src/main.js --name kitchen
            cd ..

            # Setup notification
            cd notification
            cat > .env << 'EOF'
            PORT=8085
            HOST=localhost
            HOST_DB=${{ secrets.HOST_DB }}
            PORT_DB=${{ secrets.PORT_DB }}
            USERNAME_DB=${{ secrets.USERNAME_DB }}
            PASSWORD_DB=${{ secrets.PASSWORD_DB }}
            DATABASE_DB=${{ secrets.DATABASE_DB }}
            X_API_KEY=${{ secrets.X_API_KEY }}
            NOTIFICATION_API_KEY=${{ secrets.NOTIFICATION_API_KEY }}
            CONNECTION_AMQP=${{ secrets.CONNECTION_AMQP }}
            LIMIT_REQUEUE=5
            TCP_PORT=8086
            TCP_HOST=localhost
            MAIL_URL=${{ secrets.MAIL_URL }}
            MAIL_API_KEY=${{ secrets.MAIL_API_KEY }}
            MAIL_SENDER=${{ secrets.MAIL_SENDER }}
            MAIL_SENDER_NAME=${{ secrets.MAIL_SENDER_NAME }}
            TTS_API_KEY=${{ secrets.TTS_API_KEY }}
            EOF
            echo "✓ Notification .env created"
            cat .env
            pm2 start dist/notification/src/main.js --name notification
            cd ..

            pm2 save
            pm2 list
