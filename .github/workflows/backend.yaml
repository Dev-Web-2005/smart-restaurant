name: "deploy-backend-smart"

on:
  push:
    branches: ["master", "release", "develop"]
    paths:
      - "src/backend/**"
      - ".github/workflows/backend.yaml"
    tags:
      - "v*"
  pull_request:
    branches: ["master", "release", "develop"]
    paths:
      - "src/backend/**"
      - ".github/workflows/backend.yaml"
  workflow_dispatch:

env:
  HOST_DB: ${{ secrets.HOST_DB }}
  PORT_DB: ${{ secrets.PORT_DB }}
  USERNAME_DB: ${{ secrets.USERNAME_DB }}
  PASSWORD_DB: ${{ secrets.PASSWORD_DB }}
  DATABASE_DB: ${{ secrets.DATABASE_DB }}
  X_API_KEY: ${{ secrets.X_API_KEY }}
  IDENTITY_API_KEY: ${{ secrets.IDENTITY_API_KEY }}
  PROFILE_API_KEY: ${{ secrets.PROFILE_API_KEY }}
  PRODUCT_API_KEY: ${{ secrets.PRODUCT_API_KEY }}
  TABLE_API_KEY: ${{ secrets.TABLE_API_KEY }}
  KITCHEN_API_KEY: ${{ secrets.KITCHEN_API_KEY }}
  NOTIFICATION_API_KEY: ${{ secrets.NOTIFICATION_API_KEY }}
  ORDER_API_KEY: ${{ secrets.ORDER_API_KEY }}
  WAITER_API_KEY: ${{ secrets.WAITER_API_KEY }}
  JWT_SECRET_KEY_ACCESS: ${{ secrets.JWT_SECRET_KEY_ACCESS }}
  JWT_SECRET_KEY_REFRESH: ${{ secrets.JWT_SECRET_KEY_REFRESH }}
  JWT_SECRET_KEY_RESET_PASSWORD: ${{ secrets.JWT_SECRET_KEY_RESET_PASSWORD }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      shared: ${{ steps.filter.outputs.shared }}
      api-gateway: ${{ steps.filter.outputs.api-gateway }}
      identity: ${{ steps.filter.outputs.identity }}
      product: ${{ steps.filter.outputs.product }}
      profile: ${{ steps.filter.outputs.profile }}
      table: ${{ steps.filter.outputs.table }}
      kitchen: ${{ steps.filter.outputs.kitchen }}
      notification: ${{ steps.filter.outputs.notification }}
      order: ${{ steps.filter.outputs.order }}
      waiter: ${{ steps.filter.outputs.waiter }}
      build-all: ${{ steps.filter.outputs.build-all }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - id: filter
        run: |
          BUILD_ALL="false"

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BUILD_ALL="true"
            echo "Manual trigger - building all services"
          fi

          if git diff --name-only HEAD~1 HEAD | grep -q ".github/workflows/backend.yaml"; then
            BUILD_ALL="true"
            echo "Workflow file changed - building all services"
          fi

          if git diff --name-only HEAD~1 HEAD | grep -q "src/backend/shared/"; then
            echo "shared=true" >> $GITHUB_OUTPUT
          else
            echo "shared=false" >> $GITHUB_OUTPUT
          fi
          if git diff --name-only HEAD~1 HEAD | grep -q "src/backend/api-gateway/"; then
            echo "api-gateway=true" >> $GITHUB_OUTPUT
          else
            echo "api-gateway=false" >> $GITHUB_OUTPUT
          fi
          if git diff --name-only HEAD~1 HEAD | grep -q "src/backend/identity/"; then
            echo "identity=true" >> $GITHUB_OUTPUT
          else
            echo "identity=false" >> $GITHUB_OUTPUT
          fi
          if git diff --name-only HEAD~1 HEAD | grep -q "src/backend/product/"; then
            echo "product=true" >> $GITHUB_OUTPUT
          else
            echo "product=false" >> $GITHUB_OUTPUT
          fi
          if git diff --name-only HEAD~1 HEAD | grep -q "src/backend/profile/"; then
            echo "profile=true" >> $GITHUB_OUTPUT
          else
            echo "profile=false" >> $GITHUB_OUTPUT
          fi
          if git diff --name-only HEAD~1 HEAD | grep -q "src/backend/table/"; then
            echo "table=true" >> $GITHUB_OUTPUT
          else
            echo "table=false" >> $GITHUB_OUTPUT
          fi
          if git diff --name-only HEAD~1 HEAD | grep -q "src/backend/kitchen/"; then
            echo "kitchen=true" >> $GITHUB_OUTPUT
          else
            echo "kitchen=false" >> $GITHUB_OUTPUT
          fi
          if git diff --name-only HEAD~1 HEAD | grep -q "src/backend/notification/"; then
            echo "notification=true" >> $GITHUB_OUTPUT
          else
            echo "notification=false" >> $GITHUB_OUTPUT
          fi
          if git diff --name-only HEAD~1 HEAD | grep -q "src/backend/order/"; then
            echo "order=true" >> $GITHUB_OUTPUT
          else
            echo "order=false" >> $GITHUB_OUTPUT
          fi
          if git diff --name-only HEAD~1 HEAD | grep -q "src/backend/waiter/"; then
            echo "waiter=true" >> $GITHUB_OUTPUT
          else
            echo "waiter=false" >> $GITHUB_OUTPUT
          fi

          echo "build-all=$BUILD_ALL" >> $GITHUB_OUTPUT

  backup:
    needs: detect-changes
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          key: ${{ secrets.VPS_KEY }}
          port: ${{ secrets.VPS_PORT }}
          username: ${{ secrets.VPS_USER }}
          command_timeout: 10m
          script: |
            set -e
            mkdir -p /home/${{ secrets.VPS_USER }}/projects/backup
            TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
            cd /home/${{ secrets.VPS_USER }}/projects/result
            tar -czf ../backup/backend_$TIMESTAMP.tar.gz .
            echo "âœ“ Backup created: backend_$TIMESTAMP.tar.gz"
            ls -lh ../backup/backend_$TIMESTAMP.tar.gz

  build-and-deploy:
    needs: [detect-changes, backup]
    runs-on: ubuntu-latest
    services:
      rabbitmq:
        image: rabbitmq:3-management
        ports:
          - 5672:5672
        env:
          RABBITMQ_DEFAULT_USER: supper
          RABBITMQ_DEFAULT_PASS: supper
        options: --health-cmd "rabbitmq-diagnostics -q ping" --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 25

      - name: Build changed services
        id: build
        run: |
          BUILD_ALL="${{ needs.detect-changes.outputs.build-all }}"

          # Kiá»ƒm tra xem cÃ³ service nÃ o cáº§n build khÃ´ng
          if [ "$BUILD_ALL" != "true" ] && \
             [ "${{ needs.detect-changes.outputs.shared }}" != "true" ] && \
             [ "${{ needs.detect-changes.outputs.api-gateway }}" != "true" ] && \
             [ "${{ needs.detect-changes.outputs.identity }}" != "true" ] && \
             [ "${{ needs.detect-changes.outputs.product }}" != "true" ] && \
             [ "${{ needs.detect-changes.outputs.profile }}" != "true" ] && \
             [ "${{ needs.detect-changes.outputs.table }}" != "true" ] && \
             [ "${{ needs.detect-changes.outputs.kitchen }}" != "true" ] && \
             [ "${{ needs.detect-changes.outputs.notification }}" != "true" ] && \
             [ "${{ needs.detect-changes.outputs.order }}" != "true" ] && \
             [ "${{ needs.detect-changes.outputs.waiter }}" != "true" ]; then
            echo "âš ï¸ No services to build - skipping"
            echo "services_built=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          mkdir -p result
          echo "services_built=true" >> $GITHUB_OUTPUT

          # Build shared first - it's a dependency for other services
          echo "Building shared..."
          cd src/backend/shared && npm ci && npm run build && rm -rf test
          mkdir -p ../../../result/shared && cp -r . ../../../result/shared/ && cd ../../..

          if [ "$BUILD_ALL" == "true" ] || [ "${{ needs.detect-changes.outputs.api-gateway }}" == "true" ]; then
            echo "Building api-gateway..."
            cd src/backend/api-gateway && npm ci && npm run build && rm -rf src test
            mkdir -p ../../../result/api-gateway && cp -r . ../../../result/api-gateway/ && cd ../../..
          fi

          if [ "$BUILD_ALL" == "true" ] || [ "${{ needs.detect-changes.outputs.identity }}" == "true" ]; then
            echo "Building identity..."
            cd src/backend/identity && npm ci && npm run build && rm -rf src test
            mkdir -p ../../../result/identity && cp -r . ../../../result/identity/ && cd ../../..
          fi

          if [ "$BUILD_ALL" == "true" ] || [ "${{ needs.detect-changes.outputs.product }}" == "true" ]; then
            echo "Building product..."
            cd src/backend/product && npm ci && npm run build && rm -rf src test
            mkdir -p ../../../result/product && cp -r . ../../../result/product/ && cd ../../..
          fi

          if [ "$BUILD_ALL" == "true" ] || [ "${{ needs.detect-changes.outputs.profile }}" == "true" ]; then
            echo "Building profile..."
            cd src/backend/profile && npm ci && npm run build && rm -rf src test
            mkdir -p ../../../result/profile && cp -r . ../../../result/profile/ && cd ../../..
          fi

          if [ "$BUILD_ALL" == "true" ] || [ "${{ needs.detect-changes.outputs.table }}" == "true" ]; then
            echo "Building table..."
            cd src/backend/table && npm ci && npm run build && rm -rf src test
            mkdir -p ../../../result/table && cp -r . ../../../result/table/ && cd ../../..
          fi

          if [ "$BUILD_ALL" == "true" ] || [ "${{ needs.detect-changes.outputs.kitchen }}" == "true" ]; then
            echo "Building kitchen..."
            cd src/backend/kitchen && npm ci && npm run build && rm -rf src test
            mkdir -p ../../../result/kitchen && cp -r . ../../../result/kitchen/ && cd ../../..
          fi

          if [ "$BUILD_ALL" == "true" ] || [ "${{ needs.detect-changes.outputs.notification }}" == "true" ]; then
            echo "Building notification..."
            cd src/backend/notification && npm ci && npm run build && rm -rf src test
            mkdir -p ../../../result/notification && cp -r . ../../../result/notification/ && cd ../../..
          fi

          if [ "$BUILD_ALL" == "true" ] || [ "${{ needs.detect-changes.outputs.order }}" == "true" ]; then
            echo "Building order..."
            cd src/backend/order && npm ci && npm run build && rm -rf src test
            mkdir -p ../../../result/order && cp -r . ../../../result/order/ && cd ../../..
          fi

          if [ "$BUILD_ALL" == "true" ] || [ "${{ needs.detect-changes.outputs.waiter }}" == "true" ]; then
            echo "Building waiter..."
            cd src/backend/waiter && npm ci && npm run build && rm -rf src test
            mkdir -p ../../../result/waiter && cp -r . ../../../result/waiter/ && cd ../../..
          fi

      - uses: actions/upload-artifact@v4
        if: steps.build.outputs.services_built == 'true'
        with:
          name: backend-build
          path: result
          if-no-files-found: warn

      - name: Deploy to server
        if: steps.build.outputs.services_built == 'true'
        uses: appleboy/scp-action@v0.1.6
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "result/*"
          target: "/home/${{ secrets.VPS_USER }}/projects/result/"
          strip_components: 1
          overwrite: true

      - name: Restart changed services
        if: steps.build.outputs.services_built == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          key: ${{ secrets.VPS_KEY }}
          port: ${{ secrets.VPS_PORT }}
          username: ${{ secrets.VPS_USER }}
          command_timeout: 30m
          script: |
            set -e
            cd /home/${{ secrets.VPS_USER }}/projects/result

            BUILD_ALL="${{ needs.detect-changes.outputs.build-all }}"
            SERVICES_TO_RESTART=""

            if [ "$BUILD_ALL" == "true" ]; then
              echo "ðŸ”„ Full rebuild - stopping all PM2 processes..."
              pm2 stop all || true
              pm2 delete all || true
              sleep 2
            fi

            if [ "$BUILD_ALL" == "true" ] || [ "${{ needs.detect-changes.outputs.api-gateway }}" == "true" ]; then
              echo "Restarting api-gateway..."
              if [ "$BUILD_ALL" != "true" ]; then
                pm2 delete api-gateway 2>/dev/null || true
                sleep 1
              fi
              cd api-gateway
              cat > .env << 'EOF'
            PORT=8888
            MOD=production
            HOST_DB=${{ secrets.HOST_DB }}
            PORT_DB=${{ secrets.PORT_DB }}
            USERNAME_DB=${{ secrets.USERNAME_DB }}
            PASSWORD_DB=${{ secrets.PASSWORD_DB }}
            DATABASE_DB=${{ secrets.DATABASE_DB }}
            X_API_KEY=${{ secrets.X_API_KEY }}
            IDENTITY_API_KEY=${{ secrets.IDENTITY_API_KEY }}
            PROFILE_API_KEY=${{ secrets.PROFILE_API_KEY }}
            PRODUCT_API_KEY=${{ secrets.PRODUCT_API_KEY }}
            TABLE_API_KEY=${{ secrets.TABLE_API_KEY }}
            IDENTITY_SERVICE_URL=${{ vars.IDENTITY_SERVICE_URL }}
            HOST_IDENTITY_SERVICE=${{ vars.HOST_IDENTITY_SERVICE }}
            PORT_IDENTITY_SERVICE=${{ vars.PORT_IDENTITY_SERVICE }}
            PROFILE_SERVICE_URL=${{ vars.PROFILE_SERVICE_URL }}
            HOST_PROFILE_SERVICE=${{ vars.HOST_PROFILE_SERVICE }}
            PORT_PROFILE_SERVICE=${{ vars.PORT_PROFILE_SERVICE }}
            PRODUCT_SERVICE_URL=${{ vars.PRODUCT_SERVICE_URL }}
            HOST_PRODUCT_SERVICE=${{ vars.HOST_PRODUCT_SERVICE }}
            PORT_PRODUCT_SERVICE=${{ vars.PORT_PRODUCT_SERVICE }}
            TABLE_SERVICE_URL=${{ vars.TABLE_SERVICE_URL }}
            HOST_TABLE_SERVICE=${{ vars.HOST_TABLE_SERVICE }}
            PORT_TABLE_SERVICE=${{ vars.PORT_TABLE_SERVICE }}
            HOST_NOTIFICATION_SERVICE=${{ vars.HOST_NOTIFICATION_SERVICE }}
            PORT_NOTIFICATION_SERVICE=${{ vars.PORT_NOTIFICATION_SERVICE }}
            NOTIFICATION_API_KEY=${{ secrets.NOTIFICATION_API_KEY }}
            ORDER_SERVICE_URL=${{ vars.ORDER_SERVICE_URL }}
            HOST_ORDER_SERVICE=${{ vars.HOST_ORDER_SERVICE }}
            PORT_ORDER_SERVICE=${{ vars.PORT_ORDER_SERVICE }}
            ORDER_API_KEY=${{ secrets.ORDER_API_KEY }}
            HOST_WAITER_SERVICE=${{ vars.HOST_WAITER_SERVICE }}
            PORT_WAITER_SERVICE=${{ vars.PORT_WAITER_SERVICE }}
            WAITER_API_KEY=${{ secrets.WAITER_API_KEY }}
            HOST_KITCHEN_SERVICE=${{ vars.HOST_KITCHEN_SERVICE }}
            PORT_KITCHEN_SERVICE=${{ vars.PORT_KITCHEN_SERVICE }}
            KITCHEN_API_KEY=${{ secrets.KITCHEN_API_KEY }}
            CONNECTION_AMQP=${{ secrets.CONNECTION_AMQP }}
            NAME_QUEUE=api_gateway
            ORDER_EVENTS_EXCHANGE=order_events_exchange
            REFRESH_TOKEN_EXPIRES_IN=${{ secrets.REFRESH_TOKEN_EXPIRES_IN }}
            ACCESS_TOKEN_EXPIRY=5m
            REFRESH_TOKEN_EXPIRY=7d
            JWT_SECRET_KEY_ACCESS=${{ secrets.JWT_SECRET_KEY_ACCESS }}
            JWT_SECRET_KEY_REFRESH=${{ secrets.JWT_SECRET_KEY_REFRESH }}
            JWT_SECRET_KEY_RESET_PASSWORD=${{ secrets.JWT_SECRET_KEY_RESET_PASSWORD }}
            FRONTEND_URL=${{ vars.FRONTEND_URL }}
            COOKIE_DOMAIN=${{ vars.COOKIE_DOMAIN }}
            EOF
              pm2 start dist/api-gateway/src/main.js --name api-gateway
              SERVICES_TO_RESTART="$SERVICES_TO_RESTART api-gateway"
              cd ..
            fi

            if [ "$BUILD_ALL" == "true" ] || [ "${{ needs.detect-changes.outputs.identity }}" == "true" ]; then
              echo "Restarting identity..."
              if [ "$BUILD_ALL" != "true" ]; then
                pm2 delete identity 2>/dev/null || true
                sleep 1
              fi
              cd identity
              cat > .env << 'EOF'
            PORT=8080
            HOST_DB=${{ secrets.HOST_DB }}
            PORT_DB=${{ secrets.PORT_DB }}
            USERNAME_DB=${{ secrets.USERNAME_DB }}
            PASSWORD_DB=${{ secrets.PASSWORD_DB }}
            DATABASE_DB=${{ secrets.DATABASE_DB }}
            X_API_KEY=${{ secrets.X_API_KEY }}
            IDENTITY_API_KEY=${{ secrets.IDENTITY_API_KEY }}
            HOST_PROFILE_SERVICE=${{ vars.HOST_PROFILE_SERVICE }}
            PORT_PROFILE_SERVICE=${{ vars.PORT_PROFILE_SERVICE }}
            ACCESS_TOKEN_EXPIRY=5m
            REFRESH_TOKEN_EXPIRY=7d
            PROFILE_API_KEY=${{ secrets.PROFILE_API_KEY }}
            JWT_SECRET_KEY_ACCESS=${{ secrets.JWT_SECRET_KEY_ACCESS }}
            JWT_SECRET_KEY_REFRESH=${{ secrets.JWT_SECRET_KEY_REFRESH }}
            JWT_SECRET_KEY_RESET_PASSWORD=${{ secrets.JWT_SECRET_KEY_RESET_PASSWORD }}
            FRONTEND_URL=${{ vars.FRONTEND_URL }}
            CONNECTION_AMQP=${{ secrets.CONNECTION_AMQP }}
            NOTIFICATION_API_KEY=${{ secrets.NOTIFICATION_API_KEY }}
            REDIS_HOST=${{ secrets.REDIS_HOST }}
            REDIS_PORT=${{ secrets.REDIS_PORT }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            CLIENT_ID=${{ secrets.CLIENT_ID }}
            CLIENT_SECRET=${{ secrets.CLIENT_SECRET }}
            REDIRECT_URI=${{ secrets.REDIRECT_URI }}
            QUEUE_NAME_OF_NOTIFICATION=notification
            EOF
              pm2 start dist/identity/src/main.js --name identity
              SERVICES_TO_RESTART="$SERVICES_TO_RESTART identity"
              cd ..
            fi

            if [ "$BUILD_ALL" == "true" ] || [ "${{ needs.detect-changes.outputs.product }}" == "true" ]; then
              echo "Restarting product..."
              if [ "$BUILD_ALL" != "true" ]; then
                pm2 delete product 2>/dev/null || true
                sleep 1
              fi
              cd product
              cat > .env << 'EOF'
            PORT=8082
            HOST_DB=${{ secrets.HOST_DB }}
            PORT_DB=${{ secrets.PORT_DB }}
            USERNAME_DB=${{ secrets.USERNAME_DB }}
            PASSWORD_DB=${{ secrets.PASSWORD_DB }}
            DATABASE_DB=${{ secrets.DATABASE_DB }}
            X_API_KEY=${{ secrets.X_API_KEY }}
            PRODUCT_API_KEY=${{ secrets.PRODUCT_API_KEY }}
            EOF
              pm2 start dist/product/src/main.js --name product
              SERVICES_TO_RESTART="$SERVICES_TO_RESTART product"
              cd ..
            fi

            if [ "$BUILD_ALL" == "true" ] || [ "${{ needs.detect-changes.outputs.profile }}" == "true" ]; then
              echo "Restarting profile..."
              if [ "$BUILD_ALL" != "true" ]; then
                pm2 delete profile 2>/dev/null || true
                sleep 1
              fi
              cd profile
              cat > .env << 'EOF'
            PORT=8081
            HOST_DB=${{ secrets.HOST_DB }}
            PORT_DB=${{ secrets.PORT_DB }}
            USERNAME_DB=${{ secrets.USERNAME_DB }}
            PASSWORD_DB=${{ secrets.PASSWORD_DB }}
            DATABASE_DB=${{ secrets.DATABASE_DB }}
            X_API_KEY=${{ secrets.X_API_KEY }}
            PROFILE_API_KEY=${{ secrets.PROFILE_API_KEY }}
            EOF
              pm2 start dist/profile/src/main.js --name profile
              SERVICES_TO_RESTART="$SERVICES_TO_RESTART profile"
              cd ..
            fi

            if [ "$BUILD_ALL" == "true" ] || [ "${{ needs.detect-changes.outputs.table }}" == "true" ]; then
              echo "Restarting table..."
              if [ "$BUILD_ALL" != "true" ]; then
                pm2 delete table 2>/dev/null || true
                sleep 1
              fi
              cd table
              cat > .env << 'EOF'
            PORT=8083
            HOST_DB=${{ secrets.HOST_DB }}
            PORT_DB=${{ secrets.PORT_DB }}
            USERNAME_DB=${{ secrets.USERNAME_DB }}
            PASSWORD_DB=${{ secrets.PASSWORD_DB }}
            DATABASE_DB=${{ secrets.DATABASE_DB }}
            X_API_KEY=${{ secrets.X_API_KEY }}
            TABLE_API_KEY=${{ secrets.TABLE_API_KEY }}
            HOST_PRODUCT_SERVICE=${{ vars.HOST_PRODUCT_SERVICE }}
            PORT_PRODUCT_SERVICE=${{ vars.PORT_PRODUCT_SERVICE }}
            PRODUCT_API_KEY=${{ secrets.PRODUCT_API_KEY }}
            QR_SECRET_KEY=${{ secrets.QR_SECRET_KEY }}
            QR_BASE_URL=${{ vars.QR_BASE_URL }}
            EOF
              pm2 start dist/table/src/main.js --name table
              SERVICES_TO_RESTART="$SERVICES_TO_RESTART table"
              cd ..
            fi

            if [ "$BUILD_ALL" == "true" ] || [ "${{ needs.detect-changes.outputs.kitchen }}" == "true" ]; then
              echo "Restarting kitchen..."
              if [ "$BUILD_ALL" != "true" ]; then
                pm2 delete kitchen 2>/dev/null || true
                sleep 1
              fi
              cd kitchen
              cat > .env << 'EOF'
            PORT=8086
            HOST_DB=${{ secrets.HOST_DB }}
            PORT_DB=${{ secrets.PORT_DB }}
            USERNAME_DB=${{ secrets.USERNAME_DB }}
            PASSWORD_DB=${{ secrets.PASSWORD_DB }}
            DATABASE_DB=${{ secrets.DATABASE_DB }}
            X_API_KEY=${{ secrets.X_API_KEY }}
            KITCHEN_API_KEY=${{ secrets.KITCHEN_API_KEY }}
            CONNECTION_AMQP=${{ secrets.CONNECTION_AMQP }}
            LIMIT_REQUEUE=10
            NAME_QUEUE=kitchen
            ORDER_EVENTS_EXCHANGE=order_events_exchange
            ORDER_API_KEY=${{ secrets.ORDER_API_KEY }}
            HOST_ORDER_SERVICE=${{ vars.HOST_ORDER_SERVICE }}
            PORT_ORDER_SERVICE=${{ vars.PORT_ORDER_SERVICE }}
            HOST_TABLE_SERVICE=${{ vars.HOST_TABLE_SERVICE }}
            PORT_TABLE_SERVICE=${{ vars.PORT_TABLE_SERVICE }}
            TABLE_API_KEY=${{ secrets.TABLE_API_KEY }}
            WARNING_THRESHOLD=600
            CRITICAL_THRESHOLD=900
            EOF
              pm2 start dist/kitchen/src/main.js --name kitchen
              SERVICES_TO_RESTART="$SERVICES_TO_RESTART kitchen"
              cd ..
            fi

            if [ "$BUILD_ALL" == "true" ] || [ "${{ needs.detect-changes.outputs.notification }}" == "true" ]; then
              echo "Restarting notification..."
              if [ "$BUILD_ALL" != "true" ]; then
                pm2 delete notification 2>/dev/null || true
                sleep 1
              fi
              cd notification
              cat > .env << 'EOF'
            PORT=8085
            HOST=localhost
            HOST_DB=${{ secrets.HOST_DB }}
            PORT_DB=${{ secrets.PORT_DB }}
            USERNAME_DB=${{ secrets.USERNAME_DB }}
            PASSWORD_DB=${{ secrets.PASSWORD_DB }}
            DATABASE_DB=${{ secrets.DATABASE_DB }}
            X_API_KEY=${{ secrets.X_API_KEY }}
            NOTIFICATION_API_KEY=${{ secrets.NOTIFICATION_API_KEY }}
            CONNECTION_AMQP=${{ secrets.CONNECTION_AMQP }}
            LIMIT_REQUEUE=5
            TCP_PORT=8086
            TCP_HOST=localhost
            MAIL_URL=${{ secrets.MAIL_URL }}
            MAIL_API_KEY=${{ secrets.MAIL_API_KEY }}
            MAIL_SENDER=${{ secrets.MAIL_SENDER }}
            MAIL_SENDER_NAME=${{ secrets.MAIL_SENDER_NAME }}
            TTS_API_KEY=${{ secrets.TTS_API_KEY }}
            NAME_QUEUE=notification
            EOF
              pm2 start dist/notification/src/main.js --name notification
              SERVICES_TO_RESTART="$SERVICES_TO_RESTART notification"
              cd ..
            fi

            if [ "$BUILD_ALL" == "true" ] || [ "${{ needs.detect-changes.outputs.order }}" == "true" ]; then
              echo "Restarting order..."
              if [ "$BUILD_ALL" != "true" ]; then
                pm2 delete order 2>/dev/null || true
                sleep 1
              fi
              cd order
              cat > .env << 'EOF'
            PORT=8087
            X_API_KEY=${{ secrets.X_API_KEY }}
            HOST_DB=${{ secrets.HOST_DB }}
            PORT_DB=${{ secrets.PORT_DB }}
            USERNAME_DB=${{ secrets.USERNAME_DB }}
            PASSWORD_DB=${{ secrets.PASSWORD_DB }}
            DATABASE_DB=${{ secrets.DATABASE_DB }}
            HOST_PRODUCT_SERVICE=${{ vars.HOST_PRODUCT_SERVICE }}
            PORT_PRODUCT_SERVICE=${{ vars.PORT_PRODUCT_SERVICE }}
            PRODUCT_API_KEY=${{ secrets.PRODUCT_API_KEY }}
            REDIS_HOST=${{ secrets.REDIS_HOST }}
            REDIS_PORT=${{ secrets.REDIS_PORT }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            REDIS_TTL=86400
            TAX_RATE=0.1
            ORDER_API_KEY=${{ secrets.ORDER_API_KEY }}
            CONNECTION_AMQP=${{ secrets.CONNECTION_AMQP }}
            QUEUE_NAME_OF_ORDER=order
            QUEUE_NAME_OF_WAITER=waiter
            LIMIT_REQUEUE=10
            ORDER_EVENTS_EXCHANGE=order_events_exchange
            WAITER_API_KEY=${{ secrets.WAITER_API_KEY }}
            KITCHEN_API_KEY=${{ secrets.KITCHEN_API_KEY }}
            PAYMENT_URL=${{ secrets.PAYMENT_URL }}
            PAYMENT_API_KEY=${{ secrets.PAYMENT_API_KEY }}
            URL_HOME=${{ vars.FRONTEND_URL }}
            HOST_TABLE_SERVICE=${{ vars.HOST_TABLE_SERVICE }}
            PORT_TABLE_SERVICE=${{ vars.PORT_TABLE_SERVICE }}
            TABLE_API_KEY=${{ secrets.TABLE_API_KEY }}
            EOF
              pm2 start dist/order/src/main.js --name order
              SERVICES_TO_RESTART="$SERVICES_TO_RESTART order"
              cd ..
            fi

            if [ "$BUILD_ALL" == "true" ] || [ "${{ needs.detect-changes.outputs.waiter }}" == "true" ]; then
              echo "Restarting waiter..."
              if [ "$BUILD_ALL" != "true" ]; then
                pm2 delete waiter 2>/dev/null || true
                sleep 1
              fi
              cd waiter
              cat > .env << 'EOF'
            PORT=8088
            HOST_DB=${{ secrets.HOST_DB }}
            PORT_DB=${{ secrets.PORT_DB }}
            USERNAME_DB=${{ secrets.USERNAME_DB }}
            PASSWORD_DB=${{ secrets.PASSWORD_DB }}
            DATABASE_DB=${{ secrets.DATABASE_DB }}
            CONNECTION_AMQP=${{ secrets.CONNECTION_AMQP }}
            WAITER_API_KEY=${{ secrets.WAITER_API_KEY }}
            LIMIT_REQUEUE=10
            NAME_QUEUE=waiter
            ORDER_EVENTS_EXCHANGE=order_events_exchange
            QUEUE_NAME_OF_ORDER=order
            QUEUE_NAME_OF_KITCHEN=kitchen
            ORDER_API_KEY=${{ secrets.ORDER_API_KEY }}
            KITCHEN_API_KEY=${{ secrets.KITCHEN_API_KEY }}
            EOF
              pm2 start dist/waiter/src/main.js --name waiter
              SERVICES_TO_RESTART="$SERVICES_TO_RESTART waiter"
              cd ..
            fi

            pm2 save
            echo "âœ“ Restarted services:$SERVICES_TO_RESTART"
            pm2 list
